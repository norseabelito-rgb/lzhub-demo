---
phase: 03-calendar
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/calendar/reservation-form.tsx
  - src/components/calendar/reservation-modal.tsx
  - src/components/calendar/conflict-warning.tsx
  - src/app/(dashboard)/calendar/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a reservation with name, phone, date, time, party size, notes"
    - "System warns when booking conflicts with existing reservation"
    - "System warns when booking exceeds slot capacity"
    - "User can override warnings and proceed with booking"
    - "User can edit existing reservations"
    - "User can cancel reservations"
  artifacts:
    - path: "src/components/calendar/reservation-form.tsx"
      provides: "Form with validation for reservation data"
      min_lines: 120
    - path: "src/components/calendar/reservation-modal.tsx"
      provides: "Modal wrapper for create/edit reservation"
      min_lines: 60
    - path: "src/components/calendar/conflict-warning.tsx"
      provides: "Warning UI for conflicts and capacity"
      min_lines: 40
  key_links:
    - from: "src/components/calendar/reservation-form.tsx"
      to: "src/lib/calendar/reservation-store.ts"
      via: "createReservation, hasConflict"
      pattern: "useReservationStore"
    - from: "src/components/calendar/reservation-form.tsx"
      to: "src/lib/calendar/customer-store.ts"
      via: "findOrCreateCustomer"
      pattern: "useCustomerStore"
---

<objective>
Build the reservation creation and editing flow with conflict detection.

Purpose: Deliver CALR-01 (reservation form), CALR-03 (click to edit), CALR-04 (conflict detection), and CALR-06 (edit/cancel). Staff needs to quickly book reservations during phone calls.
Output: Complete reservation form with validation, conflict warnings, and modal integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/03-calendar/03-01-SUMMARY.md (for types and store)
@src/lib/calendar/types.ts
@src/lib/calendar/reservation-store.ts
@src/components/checklists/template-form.tsx (reference for form pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Reservation Form with Validation</name>
  <files>src/components/calendar/reservation-form.tsx</files>
  <action>
Create reservation form using react-hook-form + zod (same pattern as template-form.tsx):

**Form fields:**
- customerName: string, required, min 2 chars
- customerPhone: string, required, Romanian phone regex (+40 or 07)
- customerEmail: string, optional, email format
- date: string, required (date picker)
- time: string, required (time select with 30-min intervals 10:00-21:30)
- partySize: number, required, 1-50
- occasion: select (Regular, Birthday party, Corporate event, or custom text)
- notes: textarea, optional, max 500 chars

**Presets** (per CONTEXT.md decision):
- Add preset buttons above form: "Birthday Party", "Corporate Event"
- Birthday preset: occasion='birthday', partySize=12 (default)
- Corporate preset: occasion='corporate', partySize=20 (default)
- Clicking preset pre-fills those fields

**Props:**
- mode: 'create' | 'edit'
- initialData?: Reservation (for edit mode)
- prefilledDate?: string (when clicking from calendar slot)
- prefilledTime?: string (when clicking from calendar slot)
- onSubmit: (data) => void
- onCancel: () => void

**Behavior:**
- On submit: validate with zod, check for conflicts before saving
- Show inline validation errors (Romanian messages)
- Time select disables past times if date is today
- Use shadcn Input, Label, Button components

**Customer handling:**
- On phone number blur: check if customer exists (useCustomerStore.getCustomerByPhone)
- If exists: show "Returning customer: {name}" badge, auto-fill name if empty
- This enables CALR-08 (recognize returning customers)
  </action>
  <verify>Form renders with all fields, validation works on submit</verify>
  <done>Reservation form validates input and recognizes returning customers</done>
</task>

<task type="auto">
  <name>Task 2: Create Conflict Warning and Detection</name>
  <files>src/components/calendar/conflict-warning.tsx</files>
  <action>
**conflict-warning.tsx** - Warning component for booking conflicts:

**Props:**
- conflicts: Array of { type: 'time_overlap' | 'capacity', message: string, severity: 'warning' | 'error' }
- onOverride: () => void (proceed anyway)
- onCancel: () => void

**Display:**
- Yellow background for warnings (80%+ capacity)
- Red background for errors (100% capacity or direct overlap)
- Icon: AlertTriangle from lucide-react
- Message text explaining the conflict
- Two buttons: "Rezerva oricum" (override) and "Alege alt slot" (cancel)

**Integration in form:**
Before submitting a reservation:
1. Call useReservationStore.hasConflict(date, time, partySize)
2. Also call useReservationStore.getSlotCapacity(date, time)
3. If capacity > 80%: warning (yellow zone per CONTEXT.md)
4. If capacity = 100%: error (red zone)
5. If time slot has exact overlap with existing booking: warning
6. Show ConflictWarning component if any issues found
7. User can override and save anyway (per CONTEXT.md: "staff can override")

**Visual treatment** per CONTEXT.md:
- Red zones on overlapping slots (will be used in calendar views too)
- Warning icons on conflicting reservations
  </action>
  <verify>Warning appears when booking at 80%+ capacity slot</verify>
  <done>Conflict detection warns staff but allows override</done>
</task>

<task type="auto">
  <name>Task 3: Create Reservation Modal and Wire to Calendar</name>
  <files>src/components/calendar/reservation-modal.tsx, src/app/(dashboard)/calendar/page.tsx</files>
  <action>
**reservation-modal.tsx** - Modal wrapper:
- Uses Dialog from ui/dialog
- Props: open, onOpenChange, mode ('create' | 'edit'), reservation?: Reservation, prefilledDate?, prefilledTime?
- Title: "Rezervare Noua" for create, "Editeaza Rezervare" for edit
- Contains ReservationForm
- On form submit:
  - Create mode: useReservationStore.createReservation(), also findOrCreateCustomer
  - Edit mode: useReservationStore.updateReservation()
  - Show success toast via sonner
  - Close modal
- Delete button in edit mode (with confirmation):
  - useReservationStore.cancelReservation()
  - Toast: "Rezervare anulata"

**calendar/page.tsx updates:**
- Add state: modalOpen, modalMode, selectedReservation, prefilledSlot
- Add "Rezervare Noua" button in header (visible alongside view switcher)
- Wire ReservationModal to page
- Pass onSlotClick to calendar views: opens modal in create mode with date/time prefilled
- Pass onReservationClick to reservation cards: opens modal in edit mode

**Entry points** per CONTEXT.md:
1. Click time slot in day view -> modal with time pre-filled
2. Click "Rezervare Noua" button -> modal with current date, no time
3. Click existing reservation card -> modal in edit mode

**Customer/reservation flow:**
- When saving: use useCustomerStore.findOrCreateCustomer(name, phone, email)
- This ensures customer record created/updated for history tracking
  </action>
  <verify>Can create reservation from button, from slot click, and edit existing</verify>
  <done>Full reservation CRUD workflow functional from calendar page</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. Can create reservation via "Rezervare Noua" button
3. Can create reservation by clicking time slot (date/time pre-filled)
4. Can edit reservation by clicking on it
5. Can cancel reservation from edit modal
6. Conflict warning shows at 80%+ capacity
7. Can override conflict warning and save anyway
8. Returning customer recognized by phone number
9. Toast notifications for all actions
</verification>

<success_criteria>
- CALR-01 satisfied: reservation form with all required fields
- CALR-03 satisfied: click to open form with data
- CALR-04 satisfied: conflict/overlap detection with warnings
- CALR-06 satisfied: edit and cancel functionality
- CALR-09 partial: notes field in form (presets for occasions)
- Staff can complete booking during phone call (fast flow)
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar/03-03-SUMMARY.md`
</output>
