---
phase: 04-warnings
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/components/warnings/acknowledgment-form.tsx
  - src/components/warnings/warning-detail.tsx
  - src/components/warnings/pending-warnings-list.tsx
  - src/components/warnings/index.ts
autonomous: true

must_haves:
  truths:
    - "Employee can view warning details"
    - "Employee can sign to acknowledge warning"
    - "Employee can add comments when acknowledging"
    - "Manager can mark 'refuses to sign' with witness name"
    - "System captures acknowledgment timestamp"
    - "Pending acknowledgments visible to manager"
  artifacts:
    - path: "src/components/warnings/acknowledgment-form.tsx"
      provides: "Employee acknowledgment UI with signature or refusal"
      min_lines: 100
    - path: "src/components/warnings/warning-detail.tsx"
      provides: "Full warning display with all details and signatures"
      min_lines: 80
    - path: "src/components/warnings/pending-warnings-list.tsx"
      provides: "List of warnings awaiting acknowledgment"
      min_lines: 50
  key_links:
    - from: "src/components/warnings/acknowledgment-form.tsx"
      to: "src/lib/warnings/warning-store.ts"
      via: "acknowledgeWarning, refuseWarning"
      pattern: "useWarningStore"
    - from: "src/components/warnings/acknowledgment-form.tsx"
      to: "src/components/warnings/signature-canvas.tsx"
      via: "employee signature capture"
      pattern: "SignatureCanvas"
---

<objective>
Build the employee acknowledgment flow for warnings.

Purpose: Deliver WARN-04 (employee acknowledgment with "refuses to sign" option). After manager issues warning, employee must acknowledge receipt - either by signing or having refusal documented.
Output: Acknowledgment form with signature/refusal, warning detail view, and pending warnings list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/04-warnings/04-02-SUMMARY.md
@.planning/phases/04-warnings/04-03-SUMMARY.md
@src/lib/warnings/types.ts
@src/lib/warnings/warning-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Warning Detail Component</name>
  <files>src/components/warnings/warning-detail.tsx</files>
  <action>
**warning-detail.tsx** - Full warning display:

Props:
- warning: Warning
- showAcknowledgmentSection?: boolean (default: false)
- onAcknowledge?: () => void (callback after acknowledgment)

Display sections:

**Header:**
- Warning level badge (colored by level)
- Status badge (pending/acknowledged/refused/cleared)
- "Cleared" indicator if isCleared

**Incident Information:**
- Employee name
- Violation category (Romanian label)
- Incident date (formatted with date-fns)
- Description (full text, preserve line breaks)
- Witness name if provided

**Discipline Level:**
- DisciplineStepper showing current level (readonly mode)
- If level was skipped: show justification text

**Manager Signature:**
- SignatureDisplay component
- Manager name and signature timestamp

**Acknowledgment Section (if acknowledged):**
- Employee signature (SignatureDisplay) OR "Refuza sa semneze" badge
- Employee comments if any
- Acknowledgment timestamp
- Witness name if refusal witnessed

**Cleared Section (if cleared):**
- Cleared date
- Cleared by (manager name)
- Reason for clearing

Visual styling:
- Card layout with sections separated by dividers
- Use shadcn Card, Badge, Separator components
- Muted text for labels, normal text for values
- Signatures displayed at reasonable size (max-w-[300px])
  </action>
  <verify>Component displays all warning information correctly</verify>
  <done>Warning detail shows complete incident record with signatures</done>
</task>

<task type="auto">
  <name>Task 2: Create Acknowledgment Form</name>
  <files>src/components/warnings/acknowledgment-form.tsx</files>
  <action>
**acknowledgment-form.tsx** - Employee acknowledgment interface:

Props:
- warning: Warning (the warning being acknowledged)
- currentUser: User (logged-in user - could be employee or manager acting on behalf)
- onComplete: () => void

Two modes based on who is viewing:

**Employee Mode (currentUser.id === warning.employeeId):**
- Show warning summary (category, date, description preview)
- Text: "Confirm ca am primit si inteles acest avertisment"
- Optional comments textarea: "Comentarii (optional)"
- SignatureCanvas for employee signature
- Submit button: "Confirm Primirea"
- On submit: call acknowledgeWarning(warning.id, { signature, employeeComments })

**Manager Mode (currentUser.role === 'manager'):**
- Same warning summary
- Checkbox: "Angajatul refuza sa semneze"
- If checked:
  - Hide signature canvas
  - Show witness field (required): "Martor prezent la refuz"
  - Submit button: "Inregistreaza Refuzul"
  - On submit: call refuseWarning(warning.id, witnessName)
- If not checked:
  - Show signature canvas for employee to sign (manager hands device to employee)
  - Submit button: "Confirm Primirea"
  - On submit: same as employee mode

**Validation:**
- If signing: signature required
- If refusing: witness name required
- Comments always optional

**After submit:**
- Show success toast
- Call onComplete()

Visual layout:
- Warning summary at top (read-only, compact)
- Action section below with clear instructions
- Signature canvas prominent
- Refusal checkbox clearly visible in manager mode
  </action>
  <verify>Employee can sign, manager can mark refusal</verify>
  <done>Acknowledgment captures signature or documents refusal</done>
</task>

<task type="auto">
  <name>Task 3: Create Pending Warnings List and Update Exports</name>
  <files>src/components/warnings/pending-warnings-list.tsx, src/components/warnings/index.ts</files>
  <action>
**pending-warnings-list.tsx** - List of warnings awaiting acknowledgment:

Props:
- employeeId?: string (filter by employee, or all if undefined)
- onSelectWarning: (warning: Warning) => void
- showEmployeeName?: boolean (default: true, hide when already in employee context)

Implementation:
- Fetch warnings: if employeeId, use getPendingAcknowledgments(employeeId), else getAllPendingWarnings()
- Sort by createdAt descending (newest first)
- Empty state: "Nu exista avertismente in asteptare"

Each item displays:
- Employee name (if showEmployeeName)
- Warning level badge
- Violation category
- Incident date
- "Asteapta confirmare" status badge
- Time since issued (e.g., "acum 2 zile")
- Click to select (calls onSelectWarning)

Visual:
- List with Card items
- Hover state for clickable items
- Level badge color indicates severity
- Compact layout, 2-3 lines per item

**Update index.ts** - Add new exports:
```typescript
export { SignatureCanvas } from './signature-canvas'
export { SignatureDisplay } from './signature-display'
export { DisciplineStepper } from './discipline-stepper'
export { EmployeeSelector } from './employee-selector'
export { WarningForm } from './warning-form'
export { WarningModal } from './warning-modal'
export { WarningDetail } from './warning-detail'
export { AcknowledgmentForm } from './acknowledgment-form'
export { PendingWarningsList } from './pending-warnings-list'
```
  </action>
  <verify>List shows pending warnings, clicking opens detail</verify>
  <done>Pending warnings discoverable for acknowledgment workflow</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. Warning detail shows all fields including signatures
3. Employee can acknowledge by signing
4. Employee can add comments when acknowledging
5. Manager can mark "refuses to sign" with witness
6. Pending warnings list shows items awaiting acknowledgment
7. Status updates correctly after acknowledgment
</verification>

<success_criteria>
- WARN-04 satisfied: Employee acknowledgment with "refuses to sign" option
- Both signatures visible on warning detail (manager + employee)
- Refusal properly documented with witness
- Employee comments captured
- Timestamps recorded for all actions
</success_criteria>

<output>
After completion, create `.planning/phases/04-warnings/04-04-SUMMARY.md`
</output>
