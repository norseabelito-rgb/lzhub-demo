---
phase: 03-calendar
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(dashboard)/calendar/search/page.tsx
  - src/components/calendar/customer-search.tsx
  - src/components/calendar/customer-history.tsx
  - src/components/calendar/customer-tags.tsx
autonomous: true

must_haves:
  truths:
    - "User can search reservations by customer name"
    - "User can search reservations by phone number"
    - "User can see customer visit history when viewing a customer"
    - "User can add/remove tags on customers"
    - "User can quick-book for returning customer (pre-fills contact info)"
  artifacts:
    - path: "src/app/(dashboard)/calendar/search/page.tsx"
      provides: "Dedicated search page for customer lookup"
      min_lines: 60
    - path: "src/components/calendar/customer-search.tsx"
      provides: "Search input with results list"
      min_lines: 80
    - path: "src/components/calendar/customer-history.tsx"
      provides: "Customer history display with visit list"
      min_lines: 100
  key_links:
    - from: "src/components/calendar/customer-search.tsx"
      to: "src/lib/calendar/customer-store.ts"
      via: "searchCustomers"
      pattern: "useCustomerStore.*searchCustomers"
    - from: "src/components/calendar/customer-history.tsx"
      to: "src/lib/calendar/customer-store.ts"
      via: "getCustomerHistory"
      pattern: "getCustomerHistory"
---

<objective>
Build the customer search and history viewing functionality.

Purpose: Deliver CALR-05 (search by name/phone) and CALR-08 (customer history). When a customer calls, staff needs to quickly find their record and see past visits.
Output: Dedicated search page with customer lookup, history display, and quick-book action.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/03-calendar/03-01-SUMMARY.md (for types and stores)
@src/lib/calendar/types.ts
@src/lib/calendar/customer-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Customer Search Page and Component</name>
  <files>src/app/(dashboard)/calendar/search/page.tsx, src/components/calendar/customer-search.tsx</files>
  <action>
**customer-search.tsx** - Search component:

**Props:**
- onCustomerSelect: (customer: Customer) => void

**UI:**
- Search input with search icon (lucide-react Search icon)
- Placeholder: "Cauta dupa nume, telefon sau email..."
- Debounced search (300ms) using useState + useEffect
- Results list below input

**Search behavior:**
- Call useCustomerStore.searchCustomers(query)
- Search matches name, phone, OR email (any partial match)
- Show "Niciun rezultat" if no matches
- Show loading state during debounce

**Results display:**
- Card for each customer result:
  - Name (bold)
  - Phone number
  - Tags as badges (if any)
  - "X vizite" count
  - Last visit date (if available)
- Click on result: calls onCustomerSelect

**search/page.tsx** - Dedicated search page per CONTEXT.md:
- Page title: "Cauta Clienti"
- Contains CustomerSearch component
- When customer selected: show CustomerHistory component below
- State: selectedCustomer
- Layout: search on top, history below (full width)
- Back link to /calendar
  </action>
  <verify>Search page shows at /calendar/search, typing finds customers</verify>
  <done>Customer search functional with real-time results</done>
</task>

<task type="auto">
  <name>Task 2: Create Customer History Display</name>
  <files>src/components/calendar/customer-history.tsx</files>
  <action>
**customer-history.tsx** - History component per CONTEXT.md:

**Props:**
- customer: Customer
- onQuickBook: (customer: Customer) => void

**Layout** per CONTEXT.md decision:
- Summary section at top:
  - Customer name (large)
  - Phone, email
  - Tags (with CustomerTags component)
  - Total visits count
  - Last visit date
  - "Rezerva" button (quick book action)
- Expandable details section:
  - Full visit history list
  - Collapsible by default, click to expand

**Visit history display:**
- Get reservations: useCustomerStore.getCustomerHistory(customer.phone)
- Sort by date descending (most recent first)
- Each visit row shows:
  - Date and time
  - Party size
  - Occasion (if set)
  - Status badge (completed, cancelled, no_show)
  - Notes preview (truncated)

**Quick book action:**
- "Rezerva" button in summary
- Opens reservation modal with pre-filled contact info only (per CONTEXT.md)
- Name, phone, email pre-filled
- Date, time, party size NOT pre-filled (staff picks new values)
  </action>
  <verify>Customer history shows visit count, list expands on click</verify>
  <done>Customer history displays summary and expandable visit details</done>
</task>

<task type="auto">
  <name>Task 3: Create Customer Tags Component and Wire Quick Book</name>
  <files>src/components/calendar/customer-tags.tsx, src/app/(dashboard)/calendar/search/page.tsx</files>
  <action>
**customer-tags.tsx** - Tag management component:

**Props:**
- customerId: string
- tags: string[]
- editable?: boolean (default false)

**Display mode (editable=false):**
- Row of Badge components for each tag
- Colors: VIP=gold/yellow, Birthday=pink, Corporate=blue, others=gray
- No interaction

**Edit mode (editable=true):**
- Same badges but with X button to remove
- "+" button to add new tag
- Click "+": show input field, type tag name, press Enter to add
- Suggested tags dropdown: VIP, Birthday regular, Corporate, Problematic (quick picks)
- On add/remove: call useCustomerStore.updateCustomerTags()

**Custom tags** per CONTEXT.md: staff can create their own tags (free text)

**search/page.tsx updates:**
- Pass editable=true to CustomerTags in history view
- Wire onQuickBook:
  - Open reservation modal (import from calendar page or create local)
  - Pre-fill customer contact info
  - Navigate to /calendar after booking (or stay on search with success toast)

**Add navigation:**
- Add "Cauta Clienti" link to calendar header (beside view switcher)
- Or add as icon button (Search icon) in the header
  </action>
  <verify>Can add/remove tags on customer, quick book opens modal with contact info</verify>
  <done>Tags editable, quick book flows to reservation with customer data</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. /calendar/search page accessible
3. Search finds customers by name, phone, or email
4. Selecting customer shows history summary
5. History expandable to show full visit list
6. Tags display with appropriate colors
7. Can add/remove tags in edit mode
8. Quick book opens reservation form with contact info pre-filled
</verification>

<success_criteria>
- CALR-05 satisfied: search by name/phone works
- CALR-08 satisfied: customer history visible (visit count, last visit, full list)
- CALR-09 satisfied: tags for preferences (VIP, Birthday regular, etc.)
- Quick lookup during phone call (staff can find customer fast)
- Quick book reduces data entry for returning customers
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar/03-04-SUMMARY.md`
</output>
