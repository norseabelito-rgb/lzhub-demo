---
phase: 04-warnings
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/warnings/warning-form.tsx
  - src/components/warnings/warning-modal.tsx
  - src/components/warnings/employee-selector.tsx
  - src/components/warnings/index.ts
autonomous: true

must_haves:
  truths:
    - "Manager can select employee to warn"
    - "Manager can select violation category"
    - "Manager can enter incident description"
    - "Manager can enter incident date"
    - "Manager must sign warning before saving"
    - "System pre-selects next discipline level based on employee history"
    - "Manager can skip levels with justification"
  artifacts:
    - path: "src/components/warnings/warning-form.tsx"
      provides: "Form for creating warnings with all required fields"
      min_lines: 150
    - path: "src/components/warnings/warning-modal.tsx"
      provides: "Modal wrapper for warning creation"
      min_lines: 60
    - path: "src/components/warnings/employee-selector.tsx"
      provides: "Employee dropdown/search component"
      min_lines: 50
  key_links:
    - from: "src/components/warnings/warning-form.tsx"
      to: "src/lib/warnings/warning-store.ts"
      via: "createWarning, getNextLevel"
      pattern: "useWarningStore"
    - from: "src/components/warnings/warning-form.tsx"
      to: "src/components/warnings/signature-canvas.tsx"
      via: "manager signature capture"
      pattern: "SignatureCanvas"
---

<objective>
Build the warning creation form with validation and manager signature.

Purpose: Deliver WARN-01 (incident recording), WARN-03 (manager signature), WARN-06 (violation categories), WARN-09 (auto-escalation pre-select). Manager needs to document incidents quickly and completely.
Output: Complete warning creation form with category selection, description, signature, and escalation awareness.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/04-warnings/04-01-SUMMARY.md
@src/lib/warnings/types.ts
@src/lib/warnings/warning-store.ts
@src/components/calendar/reservation-form.tsx (reference for form pattern with react-hook-form)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Employee Selector Component</name>
  <files>src/components/warnings/employee-selector.tsx</files>
  <action>
**employee-selector.tsx** - Select employee to warn:

Props:
- value?: string (selected employee ID)
- onChange: (employeeId: string) => void
- disabled?: boolean
- error?: string

Implementation:
- Fetch employees from auth mock-users (filter role === 'angajat')
- Use shadcn Select component (Combobox pattern)
- Display employee name in dropdown
- Search/filter by name
- Show current discipline level badge next to name (use useWarningStore.getCurrentLevel)
- Badge colors: none (green), verbal (yellow), written (orange), final (red)

Visual:
- Label: "Selecteaza Angajat"
- Placeholder: "Cauta angajat..."
- Each option shows: "{name}" + level badge if applicable
  </action>
  <verify>Component renders employee list with level badges</verify>
  <done>Employee selector shows all employees with their discipline status</done>
</task>

<task type="auto">
  <name>Task 2: Create Warning Form with Validation</name>
  <files>src/components/warnings/warning-form.tsx</files>
  <action>
**warning-form.tsx** - Main warning creation form:

Use react-hook-form + zod (same pattern as reservation-form.tsx):

**Form fields:**
- employeeId: string, required (EmployeeSelector component)
- category: ViolationCategory, required (Select from VIOLATION_CATEGORIES)
- incidentDate: Date, required (date picker, cannot be future)
- description: string, required, min 20 chars, max 2000 chars (Textarea)
- witness: string, optional (Input - per CONTEXT.md "martor" field)
- level: DisciplineLevel, required (DisciplineStepper in form mode)
- skipLevelJustification: string, required IF level skips (Textarea)
- managerSignature: string (dataUrl from SignatureCanvas)

**Zod schema:**
```typescript
const warningSchema = z.object({
  employeeId: z.string().min(1, 'Selecteaza un angajat'),
  category: z.enum(VIOLATION_CATEGORIES),
  incidentDate: z.date().max(new Date(), 'Data nu poate fi in viitor'),
  description: z.string()
    .min(20, 'Descrierea trebuie sa aiba minim 20 caractere')
    .max(2000, 'Descrierea nu poate depasi 2000 caractere'),
  witness: z.string().optional(),
  level: z.enum(DISCIPLINE_LEVELS),
  skipLevelJustification: z.string().optional(),
  managerSignature: z.string().min(1, 'Semnatura manager este obligatorie')
}).refine(/* skip level validation */)
```

**Behavior:**
- On employeeId change: call getNextLevel(employeeId) and pre-select that level
- Show current employee discipline history summary below selector
- If selected level > next recommended level: show justification field, make it required
- Category change: optionally show template preview from getTemplateForCategory()
- Description field pre-fills with template text when category selected (editable)
- Manager signature at bottom - must sign before submit is enabled
- Submit button disabled until:
  1. All required fields valid
  2. Manager signature captured

**Form sections (clean layout per CONTEXT.md):**
1. Employee selection (top)
2. Incident details (category, date, description, witness)
3. Discipline level (stepper with skip justification if needed)
4. Manager signature (bottom)

Props:
- onSubmit: (data: WarningFormData) => void
- onCancel: () => void
- managerId: string (current logged-in manager)
- managerName: string
  </action>
  <verify>Form validates all fields and requires signature before submit</verify>
  <done>Warning form captures all incident details with validation</done>
</task>

<task type="auto">
  <name>Task 3: Create Warning Modal and Update Exports</name>
  <files>src/components/warnings/warning-modal.tsx, src/components/warnings/index.ts</files>
  <action>
**warning-modal.tsx** - Modal wrapper for warning creation:

Props:
- open: boolean
- onOpenChange: (open: boolean) => void
- preselectedEmployeeId?: string (when opening from employee view)

Implementation:
- Use Dialog from ui/dialog
- Title: "Avertisment Nou"
- Contains WarningForm
- Get current user from useAuthStore for manager info
- On form submit:
  1. Call useWarningStore.createWarning() with form data
  2. Show success toast: "Avertisment inregistrat"
  3. Close modal
- On cancel: close modal

Size: Large dialog (max-w-2xl) to accommodate signature canvas

**Update index.ts** - Add new exports:
```typescript
export { SignatureCanvas } from './signature-canvas'
export { SignatureDisplay } from './signature-display'
export { DisciplineStepper } from './discipline-stepper'
export { EmployeeSelector } from './employee-selector'
export { WarningForm } from './warning-form'
export { WarningModal } from './warning-modal'
```
  </action>
  <verify>Modal opens, form submits, warning saved to store</verify>
  <done>Warning creation flow complete with modal wrapper</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes
2. Employee selector shows employees with discipline badges
3. Category selection pre-fills description template
4. Level selector pre-selects next escalation level
5. Skipping levels requires justification
6. Manager signature required before submit
7. Warning saved to store with all data
</verification>

<success_criteria>
- WARN-01 satisfied: Form captures date, description, violation type
- WARN-03 satisfied: Manager must sign before saving
- WARN-06 satisfied: Category dropdown with all violation types
- WARN-09 satisfied: Auto-preselects next discipline level
- WARN-10 partial: Template text pre-fills description
- Clean form layout (not intimidating per CONTEXT.md)
</success_criteria>

<output>
After completion, create `.planning/phases/04-warnings/04-03-SUMMARY.md`
</output>
