---
phase: 03-calendar
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/components/calendar/capacity-indicator.tsx
  - src/components/calendar/walkup-tracker.tsx
  - src/components/calendar/day-view.tsx
  - src/components/calendar/week-view.tsx
  - src/app/(dashboard)/calendar/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can see capacity usage per time slot (visual indicator)"
    - "User sees yellow warning at 80% capacity"
    - "User sees red warning at 100% capacity"
    - "User can log walk-up customers (no reservation)"
    - "Walk-ups count against slot capacity"
  artifacts:
    - path: "src/components/calendar/capacity-indicator.tsx"
      provides: "Visual capacity bar/badge for time slots"
      min_lines: 40
    - path: "src/components/calendar/walkup-tracker.tsx"
      provides: "Walk-up logging component"
      min_lines: 60
  key_links:
    - from: "src/components/calendar/capacity-indicator.tsx"
      to: "src/lib/calendar/reservation-store.ts"
      via: "getSlotCapacity"
      pattern: "getSlotCapacity"
    - from: "src/components/calendar/walkup-tracker.tsx"
      to: "src/lib/calendar/reservation-store.ts"
      via: "createReservation with walkup flag"
      pattern: "createReservation"
---

<objective>
Add capacity visualization and walk-up customer tracking to complete the calendar feature.

Purpose: Deliver CALR-07 (capacity per slot) and CALR-10 (walk-up tracking). Staff needs to see at a glance which slots are filling up and track customers who arrive without reservations.
Output: Capacity indicators on calendar views and quick walk-up logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/03-calendar/03-01-SUMMARY.md (for types and stores)
@.planning/phases/03-calendar/03-02-SUMMARY.md (for calendar views)
@.planning/phases/03-calendar/03-03-SUMMARY.md (for reservation form)
@src/lib/calendar/types.ts
@src/lib/calendar/reservation-store.ts
@src/components/calendar/day-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Capacity Indicator Component</name>
  <files>src/components/calendar/capacity-indicator.tsx</files>
  <action>
**capacity-indicator.tsx** - Visual capacity display:

**Props:**
- date: string
- time: string
- variant: 'bar' | 'badge' | 'background' (different display modes)

**Behavior:**
- Call useReservationStore.getSlotCapacity(date, time)
- Returns: { total: number, reserved: number, available: number }
- Calculate percentage: (reserved / total) * 100

**Visual states** per CONTEXT.md:
- 0-79%: Normal (green or neutral)
- 80-99%: Warning (yellow) - "Yellow at 80% capacity"
- 100%: Full (red) - "Red at 100% capacity"

**Variants:**
- 'bar': Progress bar showing fill level (for day view slot)
- 'badge': Small badge like "24/30" (for week view)
- 'background': Subtle background color on the slot itself

**Display text:**
- Show "{reserved}/{total}" or "{available} locuri libere"
- Bar variant: show percentage fill
- Badge variant: compact number display

**Colors:**
- Normal: bg-green-500/20 or neutral
- Warning: bg-yellow-500/30, text-yellow-600
- Full: bg-red-500/30, text-red-600
- Use OKLCH colors from design tokens if defined
  </action>
  <verify>Component renders capacity bar with correct colors</verify>
  <done>Capacity indicator shows fill level with color coding</done>
</task>

<task type="auto">
  <name>Task 2: Create Walk-up Tracker Component</name>
  <files>src/components/calendar/walkup-tracker.tsx, src/lib/calendar/types.ts</files>
  <action>
**types.ts update:**
- Add to Reservation type: isWalkup?: boolean (default false)
- Walk-ups are reservations without advance booking

**walkup-tracker.tsx** - Quick walk-up entry:

**Props:**
- date: string (current date)
- time: string (current/selected time)
- onComplete: () => void

**UI:**
- Compact form for quick entry
- Fields: partySize (required), customerName (optional), customerPhone (optional)
- "Adauga Walk-up" button
- Show current slot capacity before adding

**Behavior:**
- On submit: create reservation with isWalkup=true, status='completed'
- Walk-ups are immediately completed (they're already there)
- If name/phone provided: create/update customer record
- Show toast: "Walk-up adaugat ({partySize} persoane)"
- Walk-ups count against capacity

**Design:**
- Can be a collapsible panel or modal
- Quick access: one-click to open, few fields, fast submit
- Show in day view footer or as floating action
  </action>
  <verify>Can add walk-up, it appears in day view and counts against capacity</verify>
  <done>Walk-up tracking functional with capacity impact</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Capacity and Walk-ups into Calendar Views</name>
  <files>src/components/calendar/day-view.tsx, src/components/calendar/week-view.tsx, src/app/(dashboard)/calendar/page.tsx</files>
  <action>
**day-view.tsx updates:**
- Add CapacityIndicator to each time slot (bar variant)
- Position: right side of slot or as background
- Slot background color changes based on capacity state
- Walk-up reservations shown with distinct styling (badge: "Walk-up")
- Add WalkupTracker at bottom of day view (collapsible)

**week-view.tsx updates:**
- Add CapacityIndicator to day columns (badge variant)
- Show daily totals: "{reserved}/{total * slots}" for the day
- Color-code days with high average capacity

**page.tsx updates:**
- Add "Walk-up" quick action button in header (visible in day view only)
- Clicking opens WalkupTracker modal with current date/time
- Refresh capacity indicators after adding reservation or walk-up

**Visual hierarchy:**
- Reservations are primary (full cards)
- Capacity is secondary (subtle indicators)
- Walk-ups distinguished but not overwhelming

**Performance:**
- Capacity calculation happens in store (getSlotCapacity)
- Memoize expensive calculations if needed
  </action>
  <verify>Day view shows capacity per slot, walk-ups visible, week view shows daily totals</verify>
  <done>Capacity visualization and walk-up tracking integrated into calendar</done>
</task>

</tasks>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete calendar system with reservations, views, search, capacity, and walk-ups</what-built>
  <how-to-verify>
    1. Go to /calendar - verify day/week/month views work
    2. Click time slot - verify reservation modal opens with time pre-filled
    3. Create a reservation - verify it appears on calendar
    4. Add multiple reservations to same slot - verify conflict warning at 80%+ capacity
    5. Go to /calendar/search - search for customer by phone
    6. View customer history - verify visits shown
    7. Use quick book - verify contact info pre-filled
    8. Add a walk-up in day view - verify it counts against capacity
    9. Check capacity indicators show correct colors (green/yellow/red)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<verification>
After all tasks complete:
1. `npm run build` passes
2. Day view shows capacity bar per time slot
3. Capacity colors: green (<80%), yellow (80-99%), red (100%)
4. Walk-up tracker accessible and functional
5. Walk-ups appear in day view with distinct styling
6. Week view shows daily capacity summary
7. All capacity affects conflict detection
</verification>

<success_criteria>
- CALR-07 satisfied: capacity per time slot visible and enforced
- CALR-10 satisfied: walk-up tracking functional
- Phase 3 complete: all 11 requirements (CALR-01 through CALR-11) addressed
- Calendar usable for real phone reservation workflow
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar/03-05-SUMMARY.md`
</output>
